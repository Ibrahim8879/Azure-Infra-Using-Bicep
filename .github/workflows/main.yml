name: 'Bicep Unit Tests'

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches:
      - main
    paths:
      - 'src/iac/az-controllers/azure-services/client/**'
      - 'src/iac/az-controllers/azure-services/shared/**'

env:
  LOCATION: "southcentralus"
  
permissions:
  id-token: write
  contents: read
  security-events: write
  actions: read

jobs:
  shared-job:
    name: 'Shared Tests'
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'shared')
    steps:
      - uses: actions/checkout@v3
      - run: echo "Running SHARED tests in $LOCATION..."

  client-job:
    name: 'Client Tests'
    runs-on: ubuntu-latest
    needs: shared-job
    if: contains(join(github.event.pull_request.labels.*.name, ' '), 'client-')
    steps:
      - uses: actions/checkout@v3

      - name: Run client deployments
        run: |
          echo "Checking client-* labels..."
          labels=$(jq -r '.pull_request.labels[].name' <<< '${{ toJson(github.event) }}' | grep '^client-' || true)

          if [ -z "$labels" ]; then
            echo "No client-* labels found."
            exit 0
          fi

          for label in $labels; do
            client_name="${label#client-}"
            echo "ðŸš€ Running deployment for client: $client_name"
            az deployment sub what-if \
              --name whatif-$client_name-${{ github.run_id }} \
              --template-file ./src/iac/az-controllers/azure-services/client/$client_name.bicep \
              --parameters ./src/params/dev/$client_name.bicepparam \
              --parameters location=$LOCATION \
              --location $LOCATION > whatif-$client_name
          done
