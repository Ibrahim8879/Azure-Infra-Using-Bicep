name: 'Bicep Unit Tests'

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches:
      - main
    paths:
      - 'src/iac/az-controllers/azure-services/client/**'
      - 'src/iac/az-controllers/azure-services/shared/**'

env:
  LOCATION: "southcentralus"
  
permissions:
  id-token: write
  contents: read
  security-events: write
  actions: read

jobs:
  sharedjob:
    name: 'Shared Tests'
    runs-on: ubuntu-latest
    steps:
      - name: Shared Job
        if: contains(github.event.pull_request.labels.*.name, 'shared')
        uses: actions/checkout@v3
        run: echo "Running SHARED tests in $LOCATION..."

      - name: Run client deployments
        if: contains(join(github.event.pull_request.labels.*.name, ' '), 'client-')
        uses: actions/checkout@v3
        run: |
          echo "Checking client-* labels..."
          labels=$(jq -r '.pull_request.labels[].name' <<< '${{ toJson(github.event) }}' | grep '^client-' || true)

          if [ -z "$labels" ]; then
            echo "No client-* labels found."
            exit 0
          fi

          for label in $labels; do
            client_name="${label#client-}"
            echo "ðŸš€ Running deployment for client: $client_name"
          done
