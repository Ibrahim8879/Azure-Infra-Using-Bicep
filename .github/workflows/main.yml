name: 'Bicep Unit Tests'

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches:
      - main
    paths:
      - 'src/iac/az-controllers/azure-services/client/**'
      - 'src/iac/az-controllers/azure-services/shared/**'

env:
  LOCATION: "southcentralus"
  
permissions:
  id-token: write
  contents: read
  pull-requests: read
  security-events: write
  actions: read

jobs:
  run-tests:
    name: "Controller Job"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Shared if labeled
        if: contains(steps.labels.outputs.labels, 'shared')
        run: |
          echo "🚀 Running Shared Deployment..."

      - name: Run Client Deployments
        run: |
          echo "🚀 Checking client-* labels..."
          labels=$(jq -r '.pull_request.labels[].name' <<< '${{ toJson(github.event) }}' | grep '^client-' || true)

          if [ -z "$labels" ]; then
            echo "No client-* labels found."
            exit 0
          fi

          for label in $labels; do
            client_name="${label#client-}"
            echo "➡️ Running deployment for client: $client_name"
          done
