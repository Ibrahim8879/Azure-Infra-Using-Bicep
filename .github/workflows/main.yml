name: 'Bicep Unit Tests'

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches:
      - main
    paths:
      - 'src/iac/az-controllers/azure-services/client/**'
      - 'src/iac/az-controllers/azure-services/shared/**'
      - 'src/params/dev/**'

env:
  LOCATION: "southcentralus"
  
permissions:
  id-token: write
  contents: read
  security-events: write
  actions: read

jobs:
  shared-job:
    name: 'Shared Tests'
    runs-on: ubuntu-latest
    if: |
      contains(github.event.pull_request.labels.*.name, 'shared') &&
      (
        contains(github.event.pull_request.changed_files.*.filename, 'src/iac/az-controllers/azure-services/shared/') ||
        contains(github.event.pull_request.changed_files.*.filename, 'src/params/dev/main.bicepparam')
      )
    steps:
      - uses: actions/checkout@v3
      - run: echo "âœ… Running SHARED tests in $LOCATION..."

  client-job:
    name: 'Client Tests'
    runs-on: ubuntu-latest
    needs: [shared-job]
    if: always() && contains(join(github.event.pull_request.labels.*.name, ' '), 'client-')
    steps:
      - uses: actions/checkout@v3
      - name: Run client deployments
        run: |
          echo "Checking client-* labels..."
          labels=$(jq -r '.pull_request.labels[].name' <<< '${{ toJson(github.event) }}' | grep '^client-' || true)

          if [ -z "$labels" ]; then
            echo "No client-* labels found."
            exit 0
          fi

          for label in $labels; do
            client_name="${label#client-}"
            echo "ðŸš€ Running deployment for client: $client_name"
          done
